## Docker Overlay Network

docker 컨테이너들을 Overlay Network로 묶어서 네트워크 터널링.

* Overay Network : 기존 네트워크 구성은 그대로 두고, 그 위에 새로운 네트워크를 구성하는 개념.
  * 서로 다른 호스트에서도 하나의 머신의 가상 네트워크에 연결된 것처럼 서로 통신이 가능.
  * etcd를 사용하면 etcd에 각 호스트간 연결 정보가 매핑이 되어 사용 시에는 내부 주소에 접근하는 것처럼 사용을 하면 내부적으로는 이 etcd가 해당 주소로 연결된 호스트에 연결해주므로써 연결이 가능하다.
  * swarm을 사용하는 경우에는 swarm이 etcd의 역할 수행
    * swarm의 매니저 노드에서 docker network를 overlay로 생성하면 같은 클러스터내의 노드들이 overlay 네트워크로 구성이된다.
    * swarm을 사용하게 되면 key-value 저장소가 필요하지 않다.
    * 동일한 네트워크에 여러 서비스를 연결할 수 있다.
    * 기본적으로 서비스 검색은 가상 IP 주소 및 DNS 항목을 swarm의 각 서비스에 할당하여 서비스 이름으로 동일한 네트워크의 컨테이너에 사용할 수 있도록 한다.
    * VIP 대신 DNS 라운드 로빈을 사용하도록 서비스를 구성할 수 있다.
    * swarm에서 오버레이 네트워크를 사용하려면 swarm 노드 사이에 다음 포트를 열어야 한다.
      * 7946 : 컨테이너 네트워크 검색을 위한 TCP/UDP 포트
      * 4789 : 컨테이너 오버레이 네트워크의 UDP 포트
  * 이렇게 가상화된 네트워크에 수많은 호스트가 등록되면 VLAN 만으로는 추가되는 MAC 주소를 감당할 수가 없어서 이를 확장한 VXLAN을 사용한다.


* 네트워크 터널링 : 다른 호스트간의  NAT들이 서로 통신할 수 있도록 하는 것.
  * 여러대의 물리 머신을 하나의 single network pool로써 deploy 할 수 있도록 하는 것.
* NAT(Network Address Translation : 네트워크 주소 변환) : IP 패킷의 TCP/UDP 포트 숫자와 소스 및 목적지의 IP 주소 등을 재기록하면서 라우터를 통해 네트워크 트래픽을 주고 받는 기술.
  * 패킷에 변화가 생기기 때문에 IP나 TCP/UDP 체크섬도 다시 계산되어 재기록해야함.
  * NAT를 사용하는 이유는 대게 사설 네트워크에 속한 여러개의 호스트가 하나의 공인 IP를 사용하여 인터넷에 접속하기 위함.



## Docker Ingress Network

* swarm을 사용하게 되면 서비스 포트를 publish해서 swarm 외부 리소스에서 쉽게 사용할 수 있다. 
* 모든 노드는 수신 라우팅 메쉬에 참여하게 된다. 
* 라우팅 메시는 들어오는 모든 요청을 사용 가능한 노드의 게시된 포트로 라우팅한다.
  * 심지어 해당 노드에 실행 중인 서비스가 없더라도 포트가 열려있으면 해당 포트로의 요청이 전달된다.





## Docker Swarm Manager

* swarm 매니저 노드는 **Raft consensus** 알고리즘을 사용하여 swarm 상태 관리
  * 클러스트에서 작업을 관리하고 예약하는 모든 관리자 노드가 동일한 일관성 있는 상태를 저장하고 있는지 확인하기 위함.
  * 일관성을 보장한다는 것은 장애가 발생할 경우 매니저 노드가 작업을 선택하여 서비스를 안정된 상태로 복원할 수 있음을 의미한다.
    * 예를 들어 리더 매니저가 예기치 않게 종료되면 다른 모든 매니저가 안정된 상태로 작업 스케쥴을 조정하고 균형을 바로잡을 수 있다.
    * 다수결에 의한 리더 선출을 위해 매니저 노드의 수는 (N/2) + 1로 유지하는 것이 좋다.
* 매니저 노드의 수에 제한은 없음
  * 성능과 내결함성 간의 절충을 통해 결정.
    * 매니저 수를 늘리면 내결함성이 향상되지만 매니저가 늘어날 수록 상태를 업데이트하기 위한 확인을 해야하기 때문에 쓰기 성능이 저하된다.
    * ​