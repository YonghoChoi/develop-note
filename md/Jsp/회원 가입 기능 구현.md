## 회원 가입 기능 구현

* 회원 가입 요청을 하면 입력을 위한 폼을 보여준다.
* 입력 폼에 아이디, 이름, 암호, 암호확인, 연락처, 이메일을 입력하고 전송하면 가입에 성공한다.
* 동일한 아이디를 가진 회원이 존재하면 에러 메시지와 함께 다시 폼을 보여준다.
* 입력한 암호와 암호확인이 일치하지 않으면 에러 메시지와 함께 다시 폼을 보여준다.



### 코드 역할

* JoinHandler : 사용자의 요청을 받는다. 
  * joinForm.jsp : 회원 가입 폼을 보여준다.
  * joinSuccess.jsp : 회원 가입 처리에 성공한 경우 결과를 보여준다.
* JoinServcie : 회원 가입 기능을 구현한다.
  * JoinRequest : 회원 가입할 때 필요한 데이터를 담는다.
    * 폼에 입력한 값을 이 객체에 담아 JoinService에 전달한다.
* AdminDao : admin 테이블과 관련된 쿼리를 실행한다.
* Admin : admin 테이블과 관련된 클래스로서 회원 데이터를 담는다.



### 회원 정보 보관을 위한 DB테이블과 관련 Admin 클래스

* 테이블 생성 쿼리

  ```sql
  create table admin (
    id int auto_increment primary key,
    name varchar(50) not null,
    password varchar(20) not null,
    gender int not null,
    phone varchar(20) not null,
    email varchar(30),
    reg_dt datetime default now()
  ) engine=InnoDB default character set = utf8;
  ```

* 데이터를 담을 Admin 클래스

  ```java
  @Getter
  @Setter
  public class Admin {
      private int id;
      private String name;
      private String password;
      private int gender;     // 0 : male, 1 : female
      private String phone;
      private String email;
      private Date regDt;

      public Admin(int id, String name, String password, int gender, String phone, String email, Date regDt) {
          this.id = id;
          this.name = name;
          this.password = password;
          this.gender = gender;
          this.phone = phone;
          this.email = email;
          this.regDt = regDt;
      }
    
      public boolean matchPassword(String password) {
          return this.password.equals(password);
      }
  }
  ```




### AdminDao 구현

```java
public class AdminDao {
    public void insert(Connection conn, Admin admin) throws SQLException {
        try(PreparedStatement pstmt
                    = conn.prepareStatement("insert into admin(name, password, gender, phone, email) values(?,?,?,?,?)")) {
            pstmt.setString(1, admin.getName());
            pstmt.setString(2, admin.getPassword());
            pstmt.setInt(3, admin.getGender());
            pstmt.setString(4, admin.getPhone());
            pstmt.setString(5, admin.getEmail());
            pstmt.executeUpdate();
        }
    }

    public void update(Connection conn, Admin admin) throws SQLException {
        try(PreparedStatement pstmt
                    = conn.prepareStatement("update admin set name=?, password=?, gender=?, phone=?, email=? where id=?")) {
            pstmt.setString(1, admin.getName());
            pstmt.setString(2, admin.getPassword());
            pstmt.setInt(3, admin.getGender());
            pstmt.setString(4, admin.getPhone());
            pstmt.setString(5, admin.getEmail());
            pstmt.setInt(6, admin.getId());
            pstmt.executeUpdate();
        }
    }

    public Admin selectByName(Connection conn, String name) throws SQLException {
        PreparedStatement pstmt = null;
        ResultSet rs = null;

        try {
            pstmt = conn.prepareStatement("select * from admin where name = ?");
            pstmt.setString(1, name);
            rs = pstmt.executeQuery();

            Admin admin = null;
            if(rs.next()) {
                admin = new Admin(
                        rs.getInt("id"),
                        rs.getString("name"),
                        rs.getString("password"),
                        rs.getInt("gender"),
                        rs.getString("phone"),
                        rs.getString("email"),
                        rs.getTimestamp("reg_dt")

                );
            }
            return admin;
        } finally {
            JdbcUtil.close(rs);
            JdbcUtil.close(pstmt);
        }
    }
}
```



### JoinService와 JoinRequest 구현

AdminDao를 이용해서 실제로 회원 가입 기능을 처리하는 코드 구현.

* JoinRequest 클래스 : JoinService가 회원 가입 기능을 구현할 때 필요한 요청 데이터를 담는 클래스.

  ```java
  @Getter
  @Setter
  public class JoinRequest {
      private String id;
      private String name;
      private int gender;
      private String phone;
      private String email;
      private String password;
      private String confirmPassword;

      public boolean isPasswordEqualConfirm() {
          return password != null && password.equals(confirmPassword);
      }

      // 값이 올바른지 검사
      public void validate(Map<String, Boolean> errors) {
          checkEmpty(errors, id, "id");
          checkEmpty(errors, name, "name");
          checkEmpty(errors, phone, "phone");
          checkEmpty(errors, email, "email");
          checkEmpty(errors, password, "password");

          if(!errors.containsKey("confirmPassword")) {
              if(!isPasswordEqualConfirm()) {
                  errors.put("notMatch", Boolean.TRUE);
              }
          }

      }

      private void checkEmpty(Map<String, Boolean> errors, String value, String fieldName) {
          if(value == null || value.isEmpty()) {
              errors.put(fieldName, Boolean.TRUE);
          }
      }
  }
  ```

  * validate() 메서드는 파라미터로 전달 받은 errors 맵 객체에 (키, True) 쌍을 추가한다.
    * 키는 어떤 에러가 발생했는지를 의미.

* 아이디 중복에 대한 Exception 추가.

  ```java
  public class DuplicateIdException extends RuntimeException{
  }
  ```

* JoinService : 회원 가입 기능 제공.

  ```java
  public class JoinService {
      private AdminDao dao = new AdminDao();

      public void join(JoinRequest joinReq) throws SQLException {
          try (Connection conn = ConnectionProvider.getConnection()){
              conn.setAutoCommit(false);  // 트랜잭션 처리를 위해 auto commit 비활성화


              Admin admin = dao.selectById(conn, joinReq.getAdminId());
              if(admin != null) {
                  JdbcUtil.rollback(conn);
                  throw new DuplicateIdException();
              }

              dao.insert(conn, new Admin(
                      joinReq.getAdminId(),
                      joinReq.getName(),
                      joinReq.getPassword(),
                      joinReq.getGender(),
                      joinReq.getPhone(),
                      joinReq.getEmail(),
                      null
              ));

              conn.commit();
          }
      }
  }
  ```



### JoinHandler와 JSP 구현

* GET 방식으로 요청이 오면 폼을 보여주는 뷰인 joinForm.jsp를 리턴

* POST 방식으로 요청이 오면 회원 가입을 처리하고 결과를 보여주는 뷰를 리턴

  * 입력 데이터가 잘못된 경우 다시 joinForm.jsp를 뷰로 리턴
  * 회원 가입에 성공한 경우 joinSuccess.jsp를 뷰로 리턴

  ```java
  public class JoinHandler implements CommandHandler{
      private static final String FORM_VIEW = "/WEB-INF/view/joinForm.jsp";
      private JoinService joinService = new JoinService();

      @Override
      public String process(HttpServletRequest req, HttpServletResponse resp) throws Exception {
          if(req.getMethod().equalsIgnoreCase("GET")) {
              return processForm(req, resp);
          } else if (req.getMethod().equalsIgnoreCase("POST")) {
              return processSubmit(req, resp);
          } else {
              resp.setStatus(HttpServletResponse.SC_METHOD_NOT_ALLOWED);
          }

          return null;
      }

      private String processForm(HttpServletRequest req, HttpServletResponse resp) {
          return FORM_VIEW;
      }

      private String processSubmit(HttpServletRequest req, HttpServletResponse resp) throws SQLException {
          JoinRequest joinReq = new JoinRequest();
          joinReq.setAdminId(req.getParameter("adminId"));
          joinReq.setName(req.getParameter("name"));
          joinReq.setGender(Integer.parseInt(req.getParameter("gender")));
          joinReq.setPhone(req.getParameter("phone"));
          joinReq.setEmail(req.getParameter("email"));
          joinReq.setPassword(req.getParameter("password"));
          joinReq.setConfirmPassword(req.getParameter("confirmPassword"));

          Map<String, Boolean> errors = new HashMap<>();
          req.setAttribute("errors", errors);

          joinReq.validate(errors);

          if(!errors.isEmpty()) {
              return FORM_VIEW;
          }

          try {
              joinService.join(joinReq);
          } catch (DuplicateIdException e) {
              e.printStackTrace();
              errors.put("duplicateId", Boolean.TRUE);
          }

          return FORM_VIEW;
      }
  }
  ```

  * 에러가 발생하는 경우 에러페이지로 이동하지 않고, 에러 메세지만 출력 후 입력 폼을 다시 보여준다.
  * request의 attribute로 errors를 추가해준 이유는 JSP 코드에서 발생한 에러에 따라 에러 메세지를 보여주기 위함이다.

* JSP 코드

  ```html
  ... 생략
  <form method="post" class="form-horizontal" action="join.do" onsubmit="return check()">
  ... 생략
  <div class="row">
  <div class="col-sm-10">
      <div class="form-group">
          <label class="col-sm-3 control-label">아이디</label>

          <div class="col-sm-9">
              <input type="text" name="adminId" id="adminId" maxlength="10"
                     placeholder="아이디" class="form-control"
                     value="">
              <c:if test="${errors.adminId}">ID를 입력하세요.</c:if>
              <c:if test="${errors.duplicateId}">이미 사용중인 아이디입니다.</c:if>
          </div>
      </div>
      <div class="form-group">
          <label class="col-sm-3 control-label">이름</label>

          <div class="col-sm-9">
              <input type="text" name="name" id="name" maxlength="10"
                     placeholder="이름" class="form-control"
                     value="">
              <c:if test="${errors.name}">이름을 입력하세요.</c:if>
          </div>
      </div>
      <div class="form-group">
          <label class="col-sm-3 control-label">패스워드</label>

          <div class="col-sm-9">
              <input type="password" name="password" maxlength="20"
                     placeholder="패스워드" class="form-control"
                     value="">
              <c:if test="${errors.password}">암호를 입력하세요.</c:if>
          </div>
      </div>
      <div class="form-group">
          <label class="col-sm-3 control-label">패스워드 확인</label>

          <div class="col-sm-9">
              <input type="password" name="confirmPassword" maxlength="20"
                     placeholder="패스워드 확인" class="form-control"
                     value="">
              <c:if test="${errors.notMatch}">암호와 일치하지 않습니다.</c:if>
          </div>
      </div>
      <div class="form-group">
          <label class="col-sm-3 control-label">성별</label>

          <div class="col-sm-4">
              <select id="select-gender" class="form-control" name="gender">
                  <option selected disabled>성별</option>
                  <option value=0>남자</option>
                  <option value=1>여자</option>
              </select>
          </div>
      </div>
      <div class="form-group">
          <label class="col-sm-3 control-label">연락처</label>

          <div class="col-sm-9">
              <input type="text" name="phone" id="phone" maxlength="12"
                     placeholder="연락처" class="form-control"
                     value="">
          </div>
      </div>
      <div class="form-group">
          <label class="col-sm-3 control-label">이메일</label>

          <div class="col-sm-9">
              <input type="email" name="email" id="email" maxlength="30"
                     placeholder="이메일" class="form-control"
                     value="">
          </div>
      </div>
  </div>
  </div>
  <div class="hr-line-dashed"></div>
  <div class="form-group">
  <div class="col-sm-12 text-center">
      <button id="cancel" class="btn btn-w-m btn-white" type="button">취소</button>
      <button class="btn btn-w-m btn-primary" type="submit"><i class="fa fa-check"></i>&nbsp;저장
      </button>
  </div>
  </div>
  ... 생략
  ```

  ​

