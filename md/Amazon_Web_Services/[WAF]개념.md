# WAF

* Amazon CloudFront 또는 Application Load Balancer로 전달되는 HTTP 및 HTTPS 요청을 모니터링 할 수 있는 웹 애플리케이션 방화벽.
* 콘텐츠에 대한 액세스를 제어할 수 있다.
  * 요청이 시작되는 IP주소 또는 쿼리 문자열의 값과 같이 사용자가 지정하는 조건에 따라 CloudFront 또는 ALB는 요청된 콘텐츠 또는 HTTP 403 상태코드로 요청에 응답.



## 동작

* 지정한 항목을 제외하고 모든 요청을 허용
* 지정한 항목을 제외하고 모든 요청을 차단
* 지정한 속성과 일치하는 요청 계산



## 장점

* 웹 요청의 특성을 사용하여 웹 공격에 대한 추가 보호를 제공
  * 요청이 시작되는 IP 주소
  * 요청 헤더 값
  * 요청에 나타나는 문자열
  * 요청 길이
  * SQL Injection 코드의 존재
  * 악성 스크립트의 존재 (교차 사이트 스크립팅)
* 지정된 조건을 충족하는 웹 요청을 허용, 차단 또는 계수 할 수 있는 규칙
* 여러 웹 애플리케이션에 재사용할 수 있는 규칙
* 실시간 지표 및 샘플링된 웹 요청
* AWS WAF API를 사용하여 자동화된 관리



## 작동 방식

조건, 규칙, 웹 ACL(웹 액세스 제어 목록)을 생성하고 조건을 정의한 후 규칙에 결합하며, 규칙을 웹 ACL에 결합한다.

### 조건

조건은 AWS WAF가 웹 요청에서 감시할 기본 특성을 정의

* 악성일 가능성이 있는 스크립트
* 요청이 시작되는 IP 주소 또는 주소 범위
* 쿼리 문자열과 같은 요청에서 지정된 부분의 길이
* 악성일 가능성이 있는 SQL 코드
  * SQL Injection
* 요청에 나타나는 문자열
  * ex) User-Agent 헤더에 나타나는 값 또는 쿼리 문자열에 나타나는 텍스트 문자열



### 규칙

조건을 규칙에 결합하여 허용,차단,계수 하려는 요청을 정확하게 대상으로 지정할 수 있음

* 일반 규칙 : 조건만 사용하여 특정 요청을 대상으로 선택
  * ex) 공격자로부터 확인한 최근 요청을 기반으로 다음 조건이 포함된 규칙을 생성할 수 있다.
    * 요청이 192.0.2.44에서 나옴
    * 요청의 User-Agent 헤더에 BadBot이라는 값이 포함되어 있음
    * 요청의 쿼리 문자열에 유사 SQL 코드가 포함되어 있는 것으로 보임
  * 여러 조건이 포함되면 AND연산. 즉, 위의 모든 조건이 일치하는 요청을 찾아냄
  * **적어도 하나의 조건을 정의 해야한다.**
    * 조건이 없는 규칙은 어떠한 요청에도 트리거되지 않음.
* 비율 기반 규칙 : 일반 규칙과 비슷하지만 비율 제한이 추가된다는 점이 다름. 
  * 지정된 IP 주소로부터 도착하는 요청의 개수를 5분 단위로 계산
  * 요청 수가 비율 제한을 초과할 경우 이 규칙이 작업을 트리거 할 수 있다.
  * 조건을 비율 제한과 결합하게 되면 요청이 모든 조건과 일치하고 5분간 요청 수가 비율제한을 초과할 경우 웹 ACL에 지정된 작업을 트리거한다.
  * ex) 공격자로부터 확인한 최근 요청을 기반으로 다음 조건이 포함된 비율 기반 규칙을 생성할 수 있음.
    * 요청이 192.0.2.44에서 나옴
    * 요청의 User-Agent 헤더에 BadBot이라는 값이 포함되어 있음
  * 위 조건에 비율 제한을 15000으로 정의한 경우 위 두 조건을 충족하고 5분간 15000개 요청을 초과하는 요청은 웹 ACL에 정의된 대로 규칙의 작업(허용 또는 차단)을 트리거한다.
  * 웹 사이트의 특정 페이지에 대한 요청을 제한하는 것도 가능
  * **조건 지정은 선택사항**
    * 조건이 없는 경우 모든 요청이 규칙과 일치하는 것으로 가정.
    * 동일한 IP 주소로부터 요청이 올 경우 비율 제한으로 계산됨.



### 웹 ACL

조건을 규칙으로 결합한 후 웹 ACL로 결합한다.

* 각 규칙에 대한 작업
  * 웹 요청이 규칙의 모든 조건과 일치하면 WAF는 요청을 차단하거나 CloudFront 또는 Application Load Balancer로 전달하도록 허용할 수 있다.
* 기본 작업
  * WAF가 웹 ACL의 하나의 규칙에서 모든 조건과 일치하지 않는 요청을 허용 또는 차단할지 결정.
  * 지정한 규칙에 세가지 조건이 존재하는 경우 여기서 해당 요청이 모든 조건에 일치하지 않고, 기본 작업이 ALLOW로 설정되어 있다면 WAF는 해당 요청을 CloudFront 또는 ALB로 전달한다.
  * 즉, 두개 이상의 조건이 설정된 경우 모든 조건을 충족하지 않는 경우에 WAF는 기본 작업을 수행한다.
  * 드문 경우지만 요청을 허용할지 차단할지에 대해 CloudFront 또는 ALB에 대한 응답이 지연되는 내부 오류가 WAF에 발생할 수 있는데, 이런 경우 일반적으로 CloudFront 또는 ALB가 콘텐츠를 제공한다.



## 용어

* 오리진 서버 : 웹 서버를 의미





## 참고

* [WAF 시작하기](http://docs.aws.amazon.com/ko_kr/waf/latest/developerguide/getting-started.html)

