# Chaos Engineering

## 클라우드 여정을 통해 배운 점

* 서비스 운영의 숙명 '장애'
  * 빨리 전파되고 늦게 복구 됨
  * 어디든 장애는 날 수 있음
  * 어떻게 빠르고 안전하게 복구 할 수 있는 가가 중요
* 많은 회사들의 장애 대응 히스토리 : github.com/danluu/post-mortems
* Jesse Robbins
  * 실제 서비스에서 장애가 발생하면 어떻게 복구가 되는가
  * 넷플릭스에서 2011년에 인프라를 위한 장애 대응 서비스 제안 - 카오스 몽키
    * 2008년에 데이터 센터 장애 발생 이후 클라우드로 이전 시작

* 넷플릭스의 마이크로서비스
  * ELB -> Zuul (API Gateway) -> 각 서비스로 전파
  * 마이크로서비스간 인터페이스 이슈 해결
    * Hystrix
      * Circuit Breaker
      * Fallback
      * 장애가 발생하면 조기에 Circuit Breaker가 차단하고 장애 확대를 방지
      * Circuit Breaker가 가동되면 미리 만들어진 응답 제공
    * Ribbon
      * Client Side Load Balancer
        * 서버의 부하 방지
    * Eureka
      * 서비스 디스커버리



## Chaos Engineering 적용 방법

* 넷플릭스는 모든 인프라에 대한 실패를 가정하고 인프라를 운영
* 카오스 엔지니어링은 실제 서비스에 장애를 주입
  * 출시 전 테스트에서 드러나지 않은 아키텍처상의 문제를 직접 드러내는 것
* Chaos Monkey
  * 실제 서비스를 죽이면 어떤 현상이 발생할까를 테스트
* Chaos Gorilla
  * 가용 영역을 날려버리면 어떤 현상이 발생할까를 테스트
* Chaos Kong
  * 리전을 날려버리면 어떤현상이 발생할까를 테스트
* 장애 발생 방법
  * 애플리케이션 부하 테스트
  * … 
* 카오스 엔지니어링의 목적은 문제를 만들려는 것은 아니고 문제를 해결하기 위한 것
* 넷플릭스에는 별도의 카오스팀이 존재
  * 카오스 엔지니어링에도 원칙이 있음
    * 폭발 반경 최소화 등
  * 책도 출간함
* 진행 과정
  * 정상 상태 : 실제 노말하게 운영되고 있는 상태
    * 노말하냐의 기준은 실제 비즈니스에서 산정되는 통계치를 기준으로 삼음
  * 가설 수립 : 장애가 나타날 수 있는 상황의 가설을 세움
  * 실험 디자인 : 어떤 시나리오로 테스트를 할 것인지를 계획하고 전파
    * 카나리 배포
  * 실험 결과 측정
    * 장애 감지 시간, 문제 인지 및 알림 시간, 사내 전파 시간, 자동 롤백 시작 시점, 복구되는 시간 등등
  * 문제점 수정
    * Post Mortems 및 오류 해결
* 전제 조건
  * 클라우드 환경
  * 마이크로서비스 환경
  * DevOps 문화



## Kubernetes를 위한 카오스 도구

### Kube Monkey

* Chaos Monkey와 의미가 동일
* Kube Monkey는 Kubernetes의 Pod들을 임의로 죽임
* Config 파일을 통해 전략을 설정
* Kube Monkey도 Kubernetes의 Deployment로 생성됨
* 데모
  * Redis Master/Slave 안정성 테스트
  * 운영 중인 Redis 클러스터를 Kube Monkey를 통해 주기적으로 랜덤하게 Terminate 시키는데 정상 운영이 되는 지를 확인



### Istio

* 서비스메시 : 라이브러리 방식을 벗어나 경량 프록시로 비즈니스 로직과 내부 네트워크 분리
  * 서비스 구동 시 통신을 위한 Proxy를 함께 배포하고 서비스간 통신은 Proxy를 통해서만 수행 (사이드카)
    * Service Mesh Plane을 통해 Proxy 통신에 대한 데이터를 수집하고 관리
* Istio는 서비스 매시용 오픈소스
  * 마이크로 서비스의 서비스간 통신, 운영 및 배포 복잡성을 해결하기 위한 분산 서비스 관리 도구
    * 지능적 라우팅, 로드밸런싱
    * 언어 및 프레임워크 독립적인 복원성
* Proxy로 Envoy 오픈소스 사용
  * 다른 프록시를 사용해도 무관함
* 트래픽 관리
  * 서비스별로 로드 밸런싱 조절 가능
  * 트래픽 정책 설정으로 Circuit Breaker 역할 수행도 가능
  * Fault Injection 기능을 통해 카오스 엔지니어링
    * Timeout
    * HTTP Abort



### 그 외 오픈소스 도구

* Chaos Toolkit

* PowerfulSeal

* Gremlin
  * 카오스 엔지니어링 관련 가장 상품성 있는 제품을 만들고 있음

